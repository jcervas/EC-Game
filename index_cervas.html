<!-- <script>
     // TO-DO

// Calculate win/lose of participant against one other randomly selected previous particpant from results.json (Vote-share starts at 50, increases by 1 for every $1 allocated, subtracted by 1 for every $1 by opponent. Voteshare will be different in future versions of this game)
// Calculate win/lose against all other participants (calculated the same way as above, but only need to store 1|0 if win or lose, and then totaled, which will be displayed in histogram
// Merge new participates data into the master database
// Build D3 svg of barchart comparing the participants allocations, the empirical averages, and the Banzhaf 'ideal'
// Build D3 svg histogram of wins against other particpants, with x-axis being percentage of wins and the y-axis being the number that falls into each bin. Make each bin 1 percentage point.
</script> -->
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <link rel="stylesheet" href="https://dhbhdrzi4tiry.cloudfront.net/cdn/sites/foundation.min.css"> -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://underscorejs.org/underscore-min.js"></script>
</head>
<style>
    .jc-input-notice {
  font-size: 13px;
  font-weight: 400;
  margin-top: 9px;
  color: #AA66D3;
}
#jc-input {
  margin-top: 30px;
  /* height: 60px; */
    font-family: sans-serif;
    margin: 1.5em auto;
    /*max-width: 700px;*/
    padding: 0 10px;
    line-height: 1.7;
    font-size: 1.1em;
    font-weight: 300;
    text-align: center;
}
.jc-hidden {
  display: none;
}
.jc-graphic {
  font-family: san-serif;
  font-size: 12px;
  font-weight: 300;
  width: 100%;
  position: relative;
  margin-bottom: 300px;
}
table {
     padding: 15px 20px 0;
    margin: 10px auto 20px;
    max-width: 600px;
    background-color: rgba(0, 0, 0, .04);
    color: #000000;
    text-align: center;
}
.jc-instructions-panel p {
    font-family: sans-serif;
    margin: 1.5em auto;
    max-width: 700px;
    padding: 0 10px;
    line-height: 1.7;
    font-size: 1.1em;
    font-weight: 300
}
.jc-overall-instructions {
  margin-bottom: 25px;
}
.jc-top-section p {
  font-size: 17px;
  line-height: 1.4em;
}

button,
input {
  padding: 5px 8px;
  margin-right: 3px;
  font-family: sans-serif;
  font-size: 13px;
  border: none;
  border-radius: 3px;
  border: 1px solid #777;
}
button.jc-submit {
  cursor: pointer;
  background: #16212B;
  border-color: #16212B;
  color: #fff;
}
button.jc-submit:disabled,
button.jc-submit.jc-disabled {
  background: #999;
  border-color: #999;
}
.jc-disabled {
  pointer-events: none;
  opacity: 0.5;
}
button:disabled {
  opacity: .5;
  pointer-events: none;
}
input {
  color: #666;
  border: 1px solid #ddd;
  background: #fff;
  text-align: center;
}
.jc-input-notice {
  font-size: 13px;
  font-weight: 400;
  margin-top: 9px;
  color: #AA66D3;
}
.jc-select-container {
  font-family: nyt-franklin;
  font-weight: 300;
  position: absolute;
  left: 100%;
  display: none;
}
#jc-note {
  font-weight: 300;
  font-size: 13px;
  color: #999;
  line-height: 1.3em;
}
blockquote p {
  color: #777;
}
blockquote {
  margin-top: 20px;
  margin-right: 20px;
  margin-bottom: 20px;
  margin-left: 20px;
}
.jc-header {
    max-width: 750px;
    margin: 0 auto 10px;
    display: block
}
h1.jc-title {
font-size: 2em;
text-align: center;
margin: 0 auto;
padding: 0 20px 10px;
font-family: sans-serif;
line-height: 1.2
}
.jc-instructions-panel li .jc-highlight,
.jc-instructions-panel p .jc-highlight {
    background-image: -webkit-gradient(linear, left top, right top, color-stop(50%, #fefefe), color-stop(50%, rgba(0, 0, 0, .09)));
    background-image: linear-gradient(90deg, #fefefe 50%, rgba(0, 0, 0, .09) 0);
    background-position: 0;
    background-size: 200%;
    -webkit-transition: all .8s;
    transition: all .8s;
font-weight: 800;
}
.jc-instructions-panel li .jc-highlight.highlighted,
.jc-instructions-panel p .jc-highlight.highlighted {
    background-position: -100%;

}
</style>

<body onload="inputboxes()">
     <div class="jc-header">
          <h1 class="jc-title">Electoral College Game</h1>
     </div>
     <div class="jc-graphic">
          <div class="jc-top-section">
               <div class="jc-select-container"></div>
               <div class="jc-instructions-panel">
                    <p>Your mission is to out-campaign your opponent, who is competing against you to be President.</p>
                    <p>Imagine that there are seven competitive states in the <span class="jc-highlight highlighted">NOTUSISTAN</span> Electoral College used for its presidential elections, operating under the same winner take all, weighted voting
                         rules as in the US Electoral
                         College.</p>
                    <p>Each player has <span class="jc-highlight highlighted">$100</span> to spend across the seven states, in increments of <span class="jc-highlight highlighted">$1</span> (No decimals or fractions in your numbers are allowed). By
                         directing resources to states, you get a competitive
                         advantage.
                         For every $1 additional spent in a state, you gain an additional 1 percentage point in vote share. For every additional $1 spent by your opponent, you lose 1 percentage point
                         (whoever spends the most money in the state, wins
                         that
                         state).</p>
                    <p>For example, if you allocate $<span class="jc-option-1"></span> to <em>State <span class="jc-state-1"></span></em>, and your opponent only allocated $<span class="jc-answer-1"></span>, you win <em>State <span class="jc-state-1a"></span>'s</em>
                         <span class="jc-ev-1"></span> EC votes. If instead you allocated $<span class="jc-option-2"></span> to <em>State <span class="jc-state-2"></span></em>, your opponent would win <span class="jc-ev-2"></span> EC votes by
                         allocating
                         anything between $<span class="jc-answer-3"></span> and $100.</p>
                    <p>The seven states have Electors shown in the second column. There is a total of 139 EC votes, with <span class="jc-highlight highlighted">70 needed to win</span>.</p>
                    <p><span class="jc-highlight highlighted">Ties in each state are decided by coin toss</span>. There is no requirement to allocate any money in a state, or you can allocate up to the full allotment in just one state.</p>
                    <p>You compete against one other person, randomly selected from our database of <span class="jc-highlight highlighted"><span class="jc-participants"></span></span> participants. You win only if you exceed 70 EC votes. </p>
                    <p>When youâ€™re ready, <span class="jc-highlight highlighted">enter your allotments below</span>. (You can play as many times as you like, but only your first guess will count.)</p>
                    <div id="jc-input">
                         <table width="50%" border="0">
                              <tr>
                                   <th scope="col">State</th>
                                   <th scope="col">EC Votes</th>
                                   <th scope="col">Initial Vote Share</th>
                                   <th scope="col">Allocation</th>
                              </tr>
                              <tr>
                                   <th scope="row">A</th>
                                   <td>3</td>
                                   <td>50%</td>
                                   <td><input id="jc-user-submit-inputA" type="tel" class="nytint-textinput jc-num" onkeyup="myFunct()" onblur="checkDecimal()" onclick="this.select()" autofocus></input></td>
                              </tr>
                              <tr>
                                   <th scope="row">B</th>
                                   <td>5</td>
                                   <td>50%</td>
                                   <td><input id="jc-user-submit-inputB" type="tel" class="nytint-textinput jc-num" onkeyup="myFunct()" onblur="checkDecimal()" onclick="this.select()"></input></td>
                              </tr>
                              <tr>
                                   <th scope="row">C</th>
                                   <td>8</td>
                                   <td>50%</td>
                                   <td><input id="jc-user-submit-inputC" type="tel" class="nytint-textinput jc-num" onkeyup="myFunct()" onblur="checkDecimal()" onclick="this.select()"></input></td>
                              </tr>
                              <tr>
                                   <th scope="row">D</th>
                                   <td>13</td>
                                   <td>50%</td>
                                   <td><input id="jc-user-submit-inputD" type="tel" class="nytint-textinput jc-num" onkeyup="myFunct()" onblur="checkDecimal()" onclick="this.select()"></input></td>
                              </tr>
                              <tr>
                                   <th scope="row">E</th>
                                   <td>21</td>
                                   <td>50%</td>
                                   <td><input id="jc-user-submit-inputE" type="tel" class="nytint-textinput jc-num" onkeyup="myFunct()" onblur="checkDecimal()" onclick="this.select()"></input></td>
                              </tr>
                              <tr>
                                   <th scope="row">F</th>
                                   <td>34</td>
                                   <td>50%</td>
                                   <td><input id="jc-user-submit-inputF" type="tel" class="nytint-textinput jc-num" onkeyup="myFunct()" onblur="checkDecimal()" onclick="this.select()"></input></td>
                              </tr>
                              <tr>
                                   <th scope="row">G</th>
                                   <td>55</td>
                                   <td>50%</td>
                                   <td><input id="jc-user-submit-inputG" type="tel" class="nytint-textinput jc-num" onkeyup="myFunct()" onblur="checkDecimal()" onclick="this.select()"></input></td>
                              </tr>
                              <tr>
                                   <th scope="row" colspan="3"></th>
                                   <td>
                                        <div>Amount Remaining: $<span id="jc-total-allocated">100</span></div>
                                   </td>
                              </tr>
                         </table>
                    <button type="button" class="jc-submit jc-disabled">Submit</button>
                    <div class="jc-input-notice jc-roundinjc-warning jc-hidden">This looks like a decimal. Just FYI, weâ€™d round it to <span class="jc-decimal-eventual-round"></span>.</div>
                    <div class="jc-input-notice jc-out-of-bounds-warning jc-hidden">Please enter a number between 0 and 100.</div>
                    <div class="jc-input-notice jc-totalHighWarning-jc-warning jc-hidden">Please adjust your allocation so it doesn't exceed $100.</div>
                    <div class="jc-input-notice jc-totalLowWarning-jc-warning jc-hidden">You have not allocated all $100!</div>
                </div>
            </div>
        </div>
    </div>
    <script>
    var userResultsUrl = "results_tmp.json"

    var graphic = d3.select(".jc-graphic"),
        submitButton = d3.select(".jc-submit"),
        bottomSection = d3.select(".jc-bottom-section"),
        inputBox = $('input'),
        histogramTitle = d3.select(".jc-histogram-title"),
        totalParticipants = d3.select(".jc-participants"),
        eventualDecimalRound = d3.select(".jc-decimal-eventual-round"),
        roundingWarning = d3.select(".jc-roundinjc-warning"),
        outOfBoundsWarning = d3.select('.jc-out-of-bounds-warning'),
        totalHighWarning = d3.select(".jc-totalHighWarning-jc-warning"),
        totalLowWarning = d3.select(".jc-totalLowWarning-jc-warning"),
        totalAlloted = d3.select(".jc-total-allocated"),
        inputA = document.getElementById("jc-user-submit-inputA"),
        inputB = document.getElementById("jc-user-submit-inputB"),
        inputC = document.getElementById("jc-user-submit-inputC"),
        inputD = document.getElementById("jc-user-submit-inputD"),
        inputE = document.getElementById("jc-user-submit-inputE"),
        inputF = document.getElementById("jc-user-submit-inputF"),
        inputG = document.getElementById("jc-user-submit-inputG");;

    var a = generateQAPairs(".jc-option-1", ".jc-answer-1", 30, 80);
    var b = generateQAPairs(".jc-option-2", ".jc-answer-2", 0, 49);
    var c = generateState(".jc-state-1", ".jc-state-1a", ".jc-ev-1");
    var c2 = generateState(".jc-state-2", ".jc-state-2a", ".jc-ev-2");

    function generateQAPairs(sel1, sel2, floor, ceil) {
        var dif = ceil - floor,
            qNum = Math.round(floor + Math.random() * dif),
            ansMin = qNum + 1
        ansNum = Math.round(Math.floor(Math.random() * qNum));

        d3.select(sel1).text(qNum);
        d3.select(sel2).text(ansNum);
        d3.select(".jc-answer-3").text(ansMin);
        return qNum;
    }

    function generateState(sel3, sel4, sel5) {
        var state = "ABCDEFG";
        var st = state.substr(Math.floor(Math.random() * 7), 1);

        if (st == "A") {
            ev = 3
        } else if (st == "B") {
            ev = 5
        } else if (st == "C") {
            ev = 8
        } else if (st == "D") {
            ev = 13
        } else if (st == "E") {
            ev = 21
        } else if (st == "F") {
            ev = 34
        } else {
            ev = 55
        }
        d3.select(sel3).text(st);
        d3.select(sel4).text(st);
        d3.select(sel5).text(ev);

        return st;
    }
    //checks that user data is equal to 100

    function myFunct() { // console.log("Checking Validity of inputs")
        totalVal = checktotalVar()
        document.getElementById("jc-total-allocated").innerHTML = (100 - totalVal);

        var vA = inputA.value;
        var vB = inputB.value;
        var vC = inputC.value;
        var vD = inputD.value;
        var vE = inputE.value;
        var vF = inputF.value;
        var vG = inputG.value;

        var isValidA = checkInputValidity(vA);
        var isValidB = checkInputValidity(vB);
        var isValidC = checkInputValidity(vC);
        var isValidD = checkInputValidity(vD);
        var isValidE = checkInputValidity(vE);
        var isValidF = checkInputValidity(vF);
        var isValidG = checkInputValidity(vG);


    }

    function inputboxes() {

        var vA = inputA.value;
        var vB = inputB.value;
        var vC = inputC.value;
        var vD = inputD.value;
        var vE = inputE.value;
        var vF = inputF.value;
        var vG = inputG.value;

        inputA.value = Math.round(vA);
        inputB.value = Math.round(vB);
        inputC.value = Math.round(vC);
        inputD.value = Math.round(vD);
        inputE.value = Math.round(vE);
        inputF.value = Math.round(vF);
        inputG.value = Math.round(vG);
        inputA.select();
    }

    function checkDecimal() {
        var vA = inputA.value;
        var vB = inputB.value;
        var vC = inputC.value;
        var vD = inputD.value;
        var vE = inputE.value;
        var vF = inputF.value;
        var vG = inputG.value;

        inputA.value = Math.round(vA);
        inputB.value = Math.round(vB);
        inputC.value = Math.round(vC);
        inputD.value = Math.round(vD);
        inputE.value = Math.round(vE);
        inputF.value = Math.round(vF);
        inputG.value = Math.round(vG);
    }

    function checkInputValidity(val) {
        totalVal = checktotalVar()

        var val2 = val;
        outOfBoundsWarning.classed('jc-hidden', val2 >= 0 && val2 <= 100);

        // if ((val2 / Math.floor(val2) !== 1) && (val2 <= 100) && !isNaN(val2 / Math.floor(val2))) {
        //fire a warning if there are decimals
        // if ((totalVal/Math.floor(totalVal) !== 1) && (totalVal <= 100) && !isNaN(totalVal/Math.floor(totalVal))) {
        //      roundingWarning.classed("jc-hidden", false);
        //      eventualDecimalRound.text(Math.round(val));
        // } else {
        //      roundingWarning.classed("jc-hidden", true);
        // }

        if (totalVal > 100) {
            totalHighWarning.classed("jc-hidden", false);
        } else {
            totalHighWarning.classed("jc-hidden", true);
        }

        if (totalVal < 100) {
            totalLowWarning.classed("jc-hidden", false);
        } else {
            totalLowWarning.classed("jc-hidden", true);
        }

        if (totalVal == 100) {
            submitButton.classed("jc-disabled", false);
        } else {
            submitButton.classed("jc-disabled", true);
        }

        return (!isNaN(val2) && (totalVar == 100));
    }

    function checktotalVar() { //checks that user data is equal to 100
        var vA = inputA.value;
        var vB = inputB.value;
        var vC = inputC.value;
        var vD = inputD.value;
        var vE = inputE.value;
        var vF = inputF.value;
        var vG = inputG.value;
        // totalVar = Math.round(Number(vA) + Number(vB) + Number(vC) + Number(vD) + Number(vE) + Number(vF) + Number(vG))
        totalVar = (Number(vA) + Number(vB) + Number(vC) + Number(vD) + Number(vE) + Number(vF) + Number(vG))
        if (totalVar == 100) {
            submitButton.classed("jc-disabled", false);
        }
        return totalVar
    }

    function showAnswer() {
        console.log("Checking Validity of Submitted Allocations")
        //check validity of answer backup
        var vA = inputA.value;
        var vB = inputB.value;
        var vC = inputC.value;
        var vD = inputD.value;
        var vE = inputE.value;
        var vF = inputF.value;
        var vG = inputG.value;

        var isValidA = checkInputValidity(vA);
        var isValidB = checkInputValidity(vB);
        var isValidC = checkInputValidity(vC);
        var isValidD = checkInputValidity(vD);
        var isValidE = checkInputValidity(vE);
        var isValidF = checkInputValidity(vF);
        var isValidG = checkInputValidity(vG);

        // var isValidTotal = checkInputTotal(vA,vB,vC,vD,vE,vF,vG)

        if (!isValidA) return;
        if (!isValidB) return;
        if (!isValidC) return;
        if (!isValidD) return;
        if (!isValidE) return;
        if (!isValidF) return;
        if (!isValidG) return;

        //deactivate text input
        inputA.blur();
        inputB.blur();
        inputC.blur();
        inputD.blur();
        inputE.blur();
        inputF.blur();
        inputG.blur();

        //turn off the whole input container
        d3.select("#jc-input").classed("jc-disabled", true);

        //what was the user's guess?
        userGuessA = +document.getElementById('jc-user-submit-inputA').value;
        userGuessB = +document.getElementById('jc-user-submit-inputB').value;
        userGuessC = +document.getElementById('jc-user-submit-inputC').value;
        userGuessD = +document.getElementById('jc-user-submit-inputD').value;
        userGuessE = +document.getElementById('jc-user-submit-inputE').value;
        userGuessF = +document.getElementById('jc-user-submit-inputF').value;
        userGuessG = +document.getElementById('jc-user-submit-inputG').value;

        var currentTime = (new Date()).getTime();

        var userData = {
            A: userGuessA,
            B: userGuessB,
            C: userGuessC,
            D: userGuessD,
            E: userGuessE,
            F: userGuessF,
            G: userGuessG,
            date: Date(),
            timePondered: ((new Date()).getTime() - currentTime) / 1000
        };
        console.log(userData)

    };

    function coinToss() {
        var coin = Math.floor(Math.random() * 1);

        if (coin == 0) {
            return 0;
        } else {
            return 1;
        }
    };

    submitButton.on("click", showAnswer);

    // This starts the collection of data from the JSON database
    d3.json(userResultsUrl)
        .then(function(data) {
            // if (error) throw error;

            console.log(data); // Shows all data in the console

            // var totalPlayers = Object.keys(data).length;
            // totalParticipants.text(totalPlayers);
            // console.log(totalPlayers) // Shows the total number of previous participants


            var means =
                d3.nest()
                .key(function(d) { return d.round; })
                .rollup(function(values) {
                    return {
                        A: d3.mean(values, function(d) { return d.A }),
                        B: d3.mean(values, function(d) { return d.B }),
                        C: d3.mean(values, function(d) { return d.C }),
                        D: d3.mean(values, function(d) { return d.D }),
                        E: d3.mean(values, function(d) { return d.E }),
                        F: d3.mean(values, function(d) { return d.F }),
                        G: d3.mean(values, function(d) { return d.G })
                    };
                })
                .map(data);

            console.log(means) // This is the empirical averages, which will be displayed in a bar chart that compares bars the height of the particpants allocations, and the Banzhaf allocation
        });


    //Begin accessing JSON data for calculations
    $.getJSON(userResultsUrl, function(data) {

            var totalPlayers = Object.keys(data).length;
            totalParticipants.text(totalPlayers);
            console.log(totalPlayers) // Shows the total number of previous participants

        var jsonID = Math.floor(Math.random() * totalPlayers);

        //parse the json file
        //var dataRead = JSON.parse(data); 

        var p1 = { userGuessA, userGuessB, userGuessC, userGuessD, userGuessE, userGuessF, userGuessG };
        var p2 = [
            { 0: data[jsonID].A }, { 1: data[jsonID].B }, { 2: data[jsonID].C }, { 3: data[jsonID].D }, { 4: data[jsonID].E }, { 5: data[jsonID].F }, { 6: data[jsonID].G },
        ];

        //Set initial vote-share to 50 for both players
        let voteSharePlayer1 = 50;
        let voteSharePlayer2 = 50;
        let wins = 0;
        let losses = 0;

        //Loop to compare user results to random player and calculate voteShare
        for (let count = 0; count <= 6; count++) {
            voteSharePlayer1 += p1[count] - p2[count].count;
        };

        //Loop to invert the equation to add to random player
        for (let count = 0; count <= 6; count++) {
            voteSharePlayer2 += p2[count].count - p1[count];
        };

        //Display both voteShares to console
        console.log(voteSharePlayer1);
        console.log(voteSharePlayer2);

        //Compare Player1 to every Player in database
        for (let i = 0; i <= totalPlayers; i++) {
            voteSharePlayer1 = 50;
            voteSharePlayer2 = 50;

            //Calc for player1
            for (let count = 0; count <= 6; count++) {
                voteSharePlayer1 += p1[count] - p2[count].count;
            };

            //Invert equation
            for (let count = 0; count <= 6; count++) {
                voteSharePlayer2 += p2[count].count - p1[count];
            };

            //Calc total win/loss to add to histogram
            if (voteSharePlayer1 > voteSharePlayer2) {
                wins++;
            } else if (voteSharePlayer1 == voteSharePlayer2) {
                wins += coinToss();
            } else {
                losses++;
            };

            //Display win/loss stats to console
            console.log("Win/lose ratio: " + wins + "|" + losses);
        };

        //Add Player1 to database
        $.each(data, function(key, value) {
            var user = ({
                "A": userGuessA,
                "B": userGuessB,
                "C": userGuessC,
                "D": userGuessD,
                "E": userGuessE,
                "F": userGuessF,
                "G": userGuessG
            });

            data.push(user);
        });

        $.ajax({
            type: "GET",
            dataType: 'json',
            async: false,
            url: userResultsUrl,
            data: { data: JSON.stringify(data) },
            success: function() { alert("File updated"); },
            failure: function() { alert("Error updating file"); }
        });

        //user.push( "<li id= '" + key + "'>" + value + "</li>");
        //$.appendTo(data);

    });
    </script>
</body>